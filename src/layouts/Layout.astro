---
import '~/assets/styles/tailwind.css';

import { I18N } from 'astrowind:config';

import CommonMeta from '~/components/common/CommonMeta.astro';
import Favicons from '~/components/Favicons.astro';
import CustomStyles from '~/components/CustomStyles.astro';
import ApplyColorMode from '~/components/common/ApplyColorMode.astro';
import Metadata from '~/components/common/Metadata.astro';
import SiteVerification from '~/components/common/SiteVerification.astro';
import Analytics from '~/components/common/Analytics.astro';
import BasicScripts from '~/components/common/BasicScripts.astro';

// Comment the line below to disable View Transitions
import { ClientRouter } from 'astro:transitions';

import type { MetaData as MetaDataType } from '~/types';

export interface Props {
  metadata?: MetaDataType;
  noindex?: boolean;
}

const { metadata = {}, noindex = false } = Astro.props;
const { language, textDirection } = I18N;
---

<!doctype html>
<html lang={language} dir={textDirection} class="2xl:text-[20px] m-0 p-0">
  <head>
    <CommonMeta />
    <Favicons />
    <CustomStyles />
    <ApplyColorMode />
    <Metadata {...metadata} />
    <SiteVerification />
    <Analytics />

    <!-- Meta Pixel Code -->
    <script is:inline>
      /* global fbq */
      /* eslint-disable */
      !(function (f, b, e, v, n, t, s) {
        if (f.fbq) return;
        n = f.fbq = function () {
          n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments);
        };
        if (!f._fbq) f._fbq = n;
        n.push = n;
        n.loaded = !0;
        n.version = '2.0';
        n.queue = [];
        t = b.createElement(e);
        t.async = !0;
        t.src = v;
        s = b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t, s);
      })(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');
      /* eslint-enable */

      fbq('init', '827225263558043');

      // URLごとに一度だけPageViewを送る
      let lastPathname = '';

      const trackMetaPage = () => {
        if (typeof window === 'undefined') return;

        const path = window.location.pathname || '/';
        if (path === lastPathname) return;
        lastPathname = path;

        // 共通 PageView
        fbq('track', 'PageView');

        // 重要ページは ViewContent も送信
        if (path === '/join' || path === '/trial') {
          fbq('track', 'ViewContent', { path });
        }
      };

      // 初回ロード
      trackMetaPage();

      // AstroのSPA遷移用イベント
      document.addEventListener('astro:page-load', trackMetaPage);
    </script>
    <noscript>
      <img
        height="1"
        width="1"
        style="display: none"
        src="https://www.facebook.com/tr?id=827225263558043&ev=PageView&noscript=1"
      />
    </noscript>
    <!-- End Meta Pixel Code -->

    {noindex && <meta name="robots" content="noindex, nofollow" />}

    <!-- Comment the line below to disable View Transitions -->
    <ClientRouter fallback="swap" />
    <slot name="head" />
  </head>

  <body class="antialiased text-default bg-page tracking-tight m-0 p-0">
    <slot />

    <BasicScripts />
  </body>
</html>
